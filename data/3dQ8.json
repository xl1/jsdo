{"name":"3dQ8","title":"BarsLang のインタプリタ","description":"<div class=\"markdown\"><p><a href=\"http://cp1.nintendo.co.jp\">http://cp1.nintendo.co.jp</a> &#x306E;&#x30A2;&#x30EC;</p>\n\n<p>&#x3064;&#x3044;&#x3067;&#x306B;&#x97F3;&#x304C;&#x306A;&#x308A;&#x307E;&#x3059;\n<a href=\"./data/3dQ8.html#l=40&amp;c=/LLi|Ll%20|lLi|l1Ll%20|1//Lli|l1/Ll%20|l1/Ll%20|1////i|\">&#x5168;&#x753B;&#x9762;</a> &#x306E;&#x307B;&#x3046;&#x304C;&#x3044;&#x3044;&#x3067;&#x3059;</p>\n</div>","libraries":["/xl1/pT68"],"js":{"language":"coffeescript","content":"#! coffeescript \nclass SoundHandler\n  toFreq = (x) ->\n    440 * Math.pow(2, x / 12)\n\n  constructor: (@lang) ->\n    @queue = []\n    \n    @sound = T('osc', new Float32Array(@lang.bs.length), 440)\n    @adsr = T('adsr', 150, 500, 500)\n    @adsr.onD = => @dequeue()\n    \n    T('*', @sound, @adsr).play()\n\n  dequeue: ->\n    if param = @queue.shift()\n      @sound.set 'wave', param.array\n      @sound.set 'freq', param.freq\n      @adsr.bang()\n    \n  play: ->\n    @queue.push {\n      array: new Float32Array(@lang.bs.toNumArray().map (x) -> x / 3)\n      freq: toFreq((@lang.acc - 1) % 128)\n    }\n    stat = @adsr.status\n    @dequeue() if (stat is 'off') or (stat is 'd')\n\n\nparseHash = ->\n  location.hash.slice(1).split('&').reduce (q, cur) ->\n    idx = cur.indexOf('=')\n    if idx < 0\n      q[cur] = undefined\n    else\n      q[cur.slice(0, idx)] = decodeURIComponent cur.slice(idx + 1)\n    q\n  , {}\n  \n$ = (id) -> document.getElementById id\n\n\nmain = ->\n  query = parseHash()\n  if not len = +query['l']\n    len = +prompt('length of bars', 24) or 24\n    location.hash += \"l=#{len}\"\n\n  lang = new BarsLang(len)\n  soundHandler = new SoundHandler(lang)\n\n  document.addEventListener 'DOMContentLoaded', ->\n    $output = $ 'output'\n    $input = $ 'input'\n    $status = $ 'status'\n    $canvas = $ 'canvas'\n\n    lang.updateRule '|', ->\n      $canvas.value += \"|#{@bs}|\\n\"\n      soundHandler.play()\n      @bs.next()\n\n    run = (commands) ->\n      $output.value = lang.run(commands) + '\\n'\n      $status.value = lang.getState()\n\n    $input.addEventListener 'keypress', ->\n      setTimeout ->\n        run $input.value.slice(-1)\n      , 0\n    , false\n\n    run($input.value = query['c'] or '')\n  , false\n  \n\nmain()"},"html":{"language":"html","content":"<script src=\"https://raw.github.com/mohayonao/timbre/master/timbre.min.js\"></script>\n    \n<textarea id=\"input\" autofocus></textarea>\n<textarea id=\"canvas\"></textarea>\n<textarea id=\"status\"></textarea>\n<textarea id=\"output\"></textarea>"},"css":{"language":"css","content":"html, body {\n  height: 100%;\n}\nbody {\n  display: -webkit-flex;\n  display: -moz-flex;\n  display: flex;\n\t-webkit-flex-flow: row wrap;\n  -moz-flex-flow: row wrap;\n  flex-flow: row wrap;\n  margin: 0;\n  overflow-x: hidden;\n}\ntextarea {\n  width: 49%;\n  -webkit-flex: 1 0 50%;\n  -moz-flex: 1 0 50%;\n  flex: 1 0 50%;\n  margin: 0;\n  padding: 0;\n  border: 0;\n  resize: none;\n}\n#input {\n  background: #ffe;\n  height: 70%;\n  height: 70vh;\n}\n#canvas {\n  background: #9cf;\n  height: 70%;\n  height: 70vh;\n}\n#output {\n  background: #9fc;\n  height: 30%;\n  height: 30vh;\n}\n#status {\n  background: #fc9;\n  height: 30%;\n  height: 30vh;\n}"},"published":"2012-09-18T23:56:37"}