{"name":"pT68","title":"BarsLang","description":"<div class=\"markdown\"><p><a href=\"http://cp1.nintendo.co.jp/\">http://cp1.nintendo.co.jp/</a> &#x306E;&#x30A2;&#x30EC;</p>\n</div>","libraries":[],"js":{"language":"coffeescript","content":"#! coffeescript\nNumber::mod = (modulo) ->\n  num = +@\n  while num <= 0\n    num += modulo\n  num % modulo\n\nString::times = (count) ->\n  (new Array(count + 1)).join @\n\n\nclass Bars\n  chars = ' iTI'\n  suc = (l, c, r) ->\n    (1 & (l + r + (c >> 1))) | (2 & (c << 1))\n\n  constructor: (str) ->\n    @_arr = str.split('').map (s) -> chars.indexOf(s)\n    @length = @_arr.length\n\n  next: ->\n    len = @length\n    newarr = []\n    for current, i in @_arr\n      before = @_arr[(i - 1).mod(len)]\n      after  = @_arr[(i + 1).mod(len)]\n      newarr[i] = suc(before, current, after)\n    @_arr.splice(0, Infinity, newarr...)\n    @\n\n  toString: ->\n    @_arr.map((i) -> chars[i]).join('')\n   \n  toNumArray: ->\n    @_arr.slice(0) #clone\n\n  set: (pos, s) ->\n    @_arr[pos] = chars.indexOf(s)\n\n\n###\n  original python script from http://cp1.nintendo.co.jp/??????/bars_lang.py\n　　オリジナルの Python コードの著作権は任天堂株式会社にあります\n###\nclass window.BarsLang\n  constructor: (n) ->\n    @bs = new Bars(' '.times n)\n    @pos = 0\n    @acc = 1\n    @accx = 1\n    @output = ''\n    @pc = 0\n    @_customRules = {}\n\n  reset: ->\n    @bs = new Bars(' '.times @bs.length)\n\n  getState: ->\n    [\n      \"|#{@bs}|\"\n      ' '.times(@pos + 1) + '^'\n      \"acc:  #{@acc}\"\n      \"accx: #{@accx}\"\n    ].join('\\n')\n    \n  updateRule: (char, func) ->\n    @_customRules[char] = func\n\n  run: (commands) ->\n    @pc = 0\n    bslen = @bs.length\n\n    while 0 <= @pc < commands.length\n      c = commands[@pc]\n      if rule = @_customRules[c]\n        rule.call(@)\n        @pc++\n        continue\n        \n      switch c\n        when '1' then @acc = 1\n        when '/' then @acc *= 2\n        when ')' then @pos = (@pos + @acc).mod(bslen)\n        when '(' then @pos = (@pos - @acc).mod(bslen)\n        when 'i', 'T', 'I', ' '\n          for i in [1..@acc]\n            @bs.set(@pos, c)\n            @pos = (@pos + 1).mod(bslen)\n        when ']'\n          t = @bs.toString()\n          s = t.slice(@pos) + t.slice(0, @pos + 1)\n          re = new RegExp('^ *[iT]* ', 'g')\n          @acc = if re.exec(s) then re.lastIndex - 1 else 0\n        when '['\n          t = @bs.toString()\n          s = t[(@pos - 1).mod(bslen)] + t.slice(@pos) + t.slice(0, @pos)\n          re = new RegExp(' [iT]* *$', 'g')\n          @acc = if m = re.exec(s) then s.length - m.index - 1 else 0\n\n        when 'l' then [@acc, @accx] = [@accx, @acc]\n        when 'L' then [@acc, @accx] = [@accx - @acc, @accx + @acc]\n        when '{' then @pc -= @acc\n        when '}' then @pc += @acc\n        when '?'\n          t = @bs.toString()\n          @acc *= 'TI i'.indexOf(t[@pos]) - 2\n        when '|'\n          console.log @bs.toString()\n          @bs.next()\n        when '!'\n          @output += String.fromCharCode((@acc + 48).mod(128))\n      @pc++\n\n    @output"},"html":{"language":"html","content":""},"css":{"language":"css","content":""},"published":"2012-09-18T19:35:44"}